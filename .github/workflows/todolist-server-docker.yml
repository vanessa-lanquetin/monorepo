
# Autogenerated by @vanessa-lanquetin/common-workflows package
# If you must edit this file, edit files in .github/workflow-*.yml
# Then launch "yarn ci:generate"

name: "Create backend container todolist-server"

# Only trigger, when the build workflow succeeded
on:
  workflow_dispatch:
    inputs:
      package_version:
        description: 'Version to build'     
        required: true

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: Receive event
        run: echo -e "ref:${{ github.ref }}\nversion:${{ inputs.package_version }}\n"

      - name: Checkout
        uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}

      - name: Publish to Registry Production
        if: "!contains(inputs.package_version, 'beta')"
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          workdir: todolist/server
          pre: echo ::save-state name=RELEASE_VERSION::$(echo ${GITHUB_REF:10})
          name: clabroche/docker-registry/todolist-server
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.NPM_TOKEN }}
          registry: docker.pkg.github.com
          tags: "latest,${{ inputs.package_version }}"
          buildargs: --build-arg NPM_TOKEN=${{secrets.NPM_TOKEN}} --build-arg PACKAGE_VERSION=${{inputs.package_version}}

      - name: Publish to Registry Prerelease
        if: "contains(inputs.package_version, 'beta')"
        uses: elgohr/Publish-Docker-Github-Action@v4
        with:
          workdir: todolist/server
          pre: echo ::save-state name=RELEASE_VERSION::$(echo ${GITHUB_REF:10})
          name: clabroche/docker-registry/todolist-server
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.NPM_TOKEN }}
          registry: docker.pkg.github.com
          tags: "prerelease,${{ inputs.package_version }}"
          buildargs: --build-arg NPM_TOKEN=${{secrets.NPM_TOKEN}} --build-arg PACKAGE_VERSION=${{inputs.package_version}}
